- Goal (incl. success criteria):
  - Match competitor install + 1‑click flows (from `C:\Users\alien\Desktop\VPN\photovpn`) using our data only; ensure new-message behavior and self-help flow align with screenshots without changing assets.
- Constraints/Assumptions:
  - Keep secrets out of git; use `.env` on server.
  - Use user-provided screenshots/copy; match competitor flow (2-column buttons) but rephrase branding.
  - Do not change assets unless explicitly requested.
  - Payments/key issuance are placeholders until provided.
- Key decisions:
  - Aiogram v3 bot; SQLite storage at `data/bot.db`; hourly reminder loop.
  - Media assets in `assets/` and helper mapping in `src/media.py`.
  - Support bot: `@GetniusSupport_bot`, channel: `https://t.me/genialvpn`, admin ID: `5795082902`.
  - Branding defaults: `Lagom VPN Pro` and `@lagvpnbot`.
  - Manual testing now; planned payment provider: YooMoney.
  - Device install screens now send new messages (no edit-in-place) to match competitor flow.
  - 1-click links now support app deep links wrapped via `DEEPLINK_REDIRECT_URL`; per-device copy updated to match screenshots.
  - If no public domain is available, `DEEPLINK_REDIRECT_URL` stays empty and direct app deeplinks are used.
  - Start flow now shows competitor-style welcome text and no immediate device prompt; device selection edits the same message.
- State:
  - Done:
    - Added media cards (welcome/pricing/pro/referral/steps) and updated bot flows to send images.
    - Added `python-dotenv`, `src/storage.py` for reminders, admin commands (`/set_expire`, `/set_plan`).
    - Updated texts/keyboards for RU/EN, 2-column device buttons, tariffs/pro/referral flows.
    - Added support/channel buttons + handlers, support bot (`src/support_bot.py`), and updated `.env.example` + `.gitignore` (add `data/`).
    - Added support/channel images into `assets/` (support.png, channel.png).
    - Removed privacy email line from profile/support copy.
    - Added 3x-ui API client scaffolding and admin issue command (`/issue`, `/xui_inbounds`).
    - Added webhook handler and systemd unit templates for main/support/webhook services.
    - Added upsert logic for existing clients via 3x-ui API.
    - Fixed RU/EN encoding issues in texts/keyboards/support bot/webhook.
    - Added profile empty-state + clarified key copy hint.
    - Added multi-inbound support via `XUI_INBOUND_IDS` and updated XUI issue flow.
    - Added ops scripts for healthchecks and update checks + systemd timers.
    - Added strict audit file `AUDIT.md`.
    - Added profile actions (resend key, switch server via subscription, check connection).
    - Added healthcheck/updatecheck envs + XUI timeout.
    - Added support ticket IDs and DB-backed language restore.
    - Shortened onboarding and reduced duplicate messages for support/channel/tariffs.
    - Updated pricing copy: trial 7 days/25 RUB, 3m 250, 12m 900.
    - Adjusted /start flow: menu line first, welcome text includes device prompt.
    - Updated default channel link to https://t.me/genialvpn.
    - Refined trial pricing copy to clarify card verification charge.
    - Reordered tariffs flow to show PRO features before pricing block.
    - Device instructions now show setup text even without key (with pay-after note).
    - Added Happ/V2RayTUN download links in device instructions (support bot greeting kept clean).
    - Added device-specific client links for non-Android setups (v2rayN/iOS v2RayTun/OpenWrt).
    - Fixed garbled Cyrillic in `src/data.py`, `src/keyboards.py`, `src/texts.py`, `src/support_bot.py`.
    - Updated device flow so selection edits same message (no extra posts) and added V2RayTUN deep link.
    - Removed visible menu-open message; reply keyboard still shown via welcome message.
    - Added V2RayA link option for macOS/Linux (`V2RAYA_URL`) and pushed commit `fbeb704`.
    - Guarded message edits against “message is not modified” errors.
    - Updated install texts and per-device keyboards to match competitor screenshots.
    - Added deep-link helpers for Happ/FlClash/V2RayTUN + optional redirect wrapper.
    - Removed device menu "Back" row and switched device selection to send new messages.
    - Added new envs for redirect + client links (Happ iOS/APK, FlClash, Sing-box).
    - Added self-help flow for “Что-то не работает” with device picker.
    - Added webhook redirect endpoint `/api/v1/redirect_dl` for deeplink wrapping.
    - Set default app link values in config and `.env.example`.
    - Left `DEEPLINK_REDIRECT_URL` empty in `.env.example` to avoid broken redirects by default.
    - Pushed commit `47bf5b4` to origin with install flow + deeplink + self-help updates.
    - Restored brand default to Lagom VPN Pro and aligned /start welcome text with competitor copy.
    - Reverted device selection to edit-in-place (no new posts).
  - Now:
    - Systemd units installed; main/support/webhook services running on server.
    - Rotate bot tokens (posted in chat) and update `.env` on server.
    - Pull latest changes on server (commit `fbeb704`) and restart bot(s).
    - Configure `.env` on server with `XUI_INBOUND_IDS`, `CHECK_URL`, XUI timeout, healthcheck/updatecheck vars.
    - Update client links for macOS/Linux in `.env` (V2rayA) if desired.
    - Fill new envs: `DEEPLINK_REDIRECT_URL`, `HAPP_IOS_URL`, `HAPP_IOS_ALT_URL`, `HAPP_APK_URL`, `FLCLASH_URL`, `SINGBOX_URL` (use our data; user doesn’t know values).
    - Deploy webhook change if using redirect endpoint.
    - User doesn’t know public domain for redirect; proceed without `DEEPLINK_REDIRECT_URL` unless provided.
    - User asked for server code; provide minimal systemd + nginx setup snippet for webhook/redirect.
    - User asked for exact server update commands (git pull + .env + restart services).
    - User reports server still running old code; need to verify service path/commit and restart.
    - Server currently on commit `232afae`; needs `git pull` to get latest commit and restart services.
    - User reports server behavior unchanged; need to verify deploy (git pull + restart) and commit hash.
    - User reports a button not working; need platform + button name + logs.
  - Next:
    - Wire payments + auto key issuance; add runbook/tests.
  - Open questions (UNCONFIRMED if needed):
    - Support bot token, support admin chat ID (if different from admin ID).
    - Final pricing, trial duration, renewal URL, YooMoney webhook format/signature.
    - Which exact button fails (device select vs 1-click), on which platform, and what happens on tap.
    - Public domain or IP for redirect endpoint (optional; only if https redirect is required).
    - What exactly looks unchanged after deploy (device selection flow, menu line, or something else).
- Working set (files/ids/commands):
  - `src/main.py`, `src/texts.py`, `src/keyboards.py`, `src/config.py`, `src/webhook.py`, `.env.example`
